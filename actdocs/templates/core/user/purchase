<section class="user-purchase">
  <h1>Purchase ticket</h1>

  <form class="form-horizontal" method="post" action="[% global.request.r.uri %]">
    <table id="act-purchase">
      [% FOREACH p IN productlist %]
        [% NEXT IF p == 'registration' AND global.request.user.has_paid %]
        <tr>
          <td>
            <input type="checkbox" value="[% p %]" id="product-[% p %]" name="product-[% p %]"[% ' checked="checked"' IF products.$p.checked %]>
          </td>
          <td>
            <label for="product-[% p %]">[% products.$p.name %]</label>
          </td>
        [% IF products.$p.prices.size == 1 %]
          <td>[% products.$p.prices.0.amount %]</td>
          <td>[% currency %]</td>
        </tr>
        [% ELSE %]
          <td colspan="2">&nbsp;</td>
        </tr>
          [% ispromo = 0 %]
          [% FOREACH i IN products.$p.prices %]
            [% UNLESS i.promocode AND ispromo %]
              <tr>
                <td>&nbsp;</td>
              [% IF i.promocode; ispromo = 1 %]
                <td><label for="promo-[% p %]">{{Promotion code}}</label></td>
                <td>
                  <input type="text" id="promo-[% p %]" name="promo-[% p %]" size="20" maxlength="20" value="[% promo.$p %]" /></td>
              [% ELSE %]
                <td>
                  <label>
                    <input type="radio" id="price-[% p %]-[% i.price_id %]" name="price-[% p %]" value="[% i.price_id %]"[% ' checked="checked"' IF i.checked %] />
                    <span>[% i.name %]</span>
                  </label>
                </td>
                <td>[% i.amount %]</td>
              [% END %]
                <td>[% currency %]</td>
              </tr>
            [% END %]
          [% END %]
        [% END %]
      [% END %]
    </table>

    <p>In addition to the regular ticket price, you can add any voulenteer donatations below:</p>
    <div class="input-wrap -text">
      <input name="donation" id="form-donation" type="text" size="5" maxlength="5" value="[% donation %]">
      <span>[% currency %]</span>
    </div>

    <div class="submit-wrap" id="total">
      <button class="button" type="submit" name="purchase">{{Buy now!}}</button>
      <b class="text-pre">{{Total}}</b>
      <b class="text-amount" id="totalamount">0</b>
      <b class="text-currency">[% currency %]</b>
    </div>
  </form>

  <p>{{Please note that everything regarding your bank account and credit card number}}</p>

  [% file = "core/bank/${global.config.payment_type}" ; PROCESS $file %]
</section>

<script type="text/javascript">
if (window.act) {
    var amounts = [% amounts %];
    $(function() {
        get_radios = function(product) { return $(":radio[name=price-" + product +"]") };
        compute_total = function() { 
            var total = 0;
            $(":checkbox[checked]").each(function() {
                var product = $(this).val();
                if (amounts[product]) {
                    if (amounts[product].single)
                        total += parseInt(amounts[product][1]);
                    else
                        get_radios(product).filter("[checked]").each(function() {
                            var price_id = $(this).val();
                            if (amounts[product][price_id])
                                total += parseInt(amounts[product][price_id]);
                        });
                }
            });
            var donation = $("#form-donation").val();
            if (donation) {
                donation = parseInt(donation);
                if (donation > 0) total += donation;
            }
            $("#totalamount").text(total);
        };
        $(":checkbox").each(function() {
            var cb = $(this);
            var radios = get_radios(cb.val());
            // checking a price: check corresponding product checkbox
            radios.click(function() {
                    cb.attr('checked',true);
                    compute_total();
                   });
            // checking a product: check 1st price
            // unchecking a product: uncheck all its prices
            cb.click(function() {
                if (cb.attr('checked'))
                    radios.filter(':first').attr('checked',true);
                else
                    radios.attr('checked',false)
                compute_total();
            });
        });
        $("#form-donation").change(compute_total);
        compute_total();
        $("#total").attr('style', 'visibility: visible');
    });
}
</script>
